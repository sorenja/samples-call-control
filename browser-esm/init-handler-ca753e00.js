import{a as e,i as t,_ as s,N as i,S as o,b as r,m as n,W as a,c as u,d as c,f as d,e as h,s as p,g as l,I as g,O as v,J as R,E as w,u as f,h as b,l as I,j as U,L as k,k as y}from"./index-83c67256.js";function E(s,i){void 0===i&&(i=e);var o=t(s)?+s-i.now():Math.abs(s);return function(e){return e.lift(new m(o,i))}}var m=function(){function e(e,t){this.delay=e,this.scheduler=t}return e.prototype.call=function(e,t){return t.subscribe(new L(e,this.delay,this.scheduler))},e}(),L=function(e){function t(t,s,i){var o=e.call(this,t)||this;return o.delay=s,o.scheduler=i,o.queue=[],o.active=!1,o.errored=!1,o}return s(t,e),t.dispatch=function(e){for(var t=e.source,s=t.queue,i=e.scheduler,o=e.destination;s.length>0&&s[0].time-i.now()<=0;)s.shift().notification.observe(o);if(s.length>0){var r=Math.max(0,s[0].time-i.now());this.schedule(e,r)}else this.unsubscribe(),t.active=!1},t.prototype._schedule=function(e){this.active=!0,this.destination.add(e.schedule(t.dispatch,this.delay,{source:this,destination:this.destination,scheduler:e}))},t.prototype.scheduleNotification=function(e){if(!0!==this.errored){var t=this.scheduler,s=new F(t.now()+this.delay,e);this.queue.push(s),!1===this.active&&this._schedule(t)}},t.prototype._next=function(e){this.scheduleNotification(i.createNext(e))},t.prototype._error=function(e){this.errored=!0,this.queue=[],this.destination.error(e),this.unsubscribe()},t.prototype._complete=function(){this.scheduleNotification(i.createComplete()),this.unsubscribe()},t}(o),F=function(){return function(e,t){this.time=e,this.notification=t}}();class D{static rawUsageFrom(e,t){return(e<<16|t)>>>0}static usagePageFromRaw(e){return e>>>16}static usageFromRaw(e){return e<<16>>>16}}class C{constructor(e){this.devices=new Map,this.deviceInputSubscriptions=new Map,this.onHidInput=new r,this.onGetFeatureReportResponse=new r;const t=new r;this.deviceAdded=t;const s=new r;this.deviceRemoved=s,e.deviceAdded.subscribe(e=>{if(!this.devices.has(e.id)){this.devices.set(e.id,e);const s=e.inputHandler.inputReports.pipe(n(t=>new a(e.id,D.usagePageFromRaw(t.usage),D.usageFromRaw(t.usage),t.value))).subscribe(e=>this.onHidInput.next(e));this.deviceInputSubscriptions.set(e.id,s),t.next(e)}}),e.deviceRemoved.subscribe(e=>{var t;this.devices.delete(e.id)&&(null===(t=this.deviceInputSubscriptions.get(e.id))||void 0===t||t.unsubscribe(),this.deviceInputSubscriptions.delete(e.id),s.next(e))})}sendOutputUsage(e,t,s,i){var o;const r=D.rawUsageFrom(t,s);null===(o=this.devices.get(e))||void 0===o||o.outputHandler.sendOutputUsage(r,i)}setFeatureUsage(e,t,s,i){var o;const r=D.rawUsageFrom(t,s);null===(o=this.devices.get(e))||void 0===o||o.featureHandler.setFeatureUsage(r,i)}getFeatureUsage(e,t,s,i){var o;return u(this,void 0,void 0,(function*(){const r=D.rawUsageFrom(s,i),n=yield null===(o=this.devices.get(e))||void 0===o?void 0:o.featureHandler.getFeatureUsage(r);void 0!==n&&this.onGetFeatureReportResponse.next(new c(t,n))}))}}class S{constructor(e,t){this.device=e,this.inputReportDescriptors=t;const s=new v(e=>(this.device.oninputreport=t=>{e.next(t)},()=>{}));this.inputReports=s.pipe(d(e=>this.device===e.currentTarget&&this.canHandleReport(e)),n(e=>({reportId:e.reportId,reportValue:e.data})),h(({reportId:e,reportValue:t})=>{const s=this.inputReportDescriptors.get(e);return Array.from(s.usages.entries(),S.makeWebHidInputReport.bind(this,t))}),p())}canHandleReport(e){return this.inputReportDescriptors.has(e.reportId)}static makeWebHidInputReport(e,[t,s]){const i=new l.BitView(e.buffer);i.bigEndian=!1;let o=i.getBits(s.offset,s.size);return o=s.onInput(o),new g.UsageReport(t,o)}}class M{constructor(e){this.report=e}reportSizeInBits(){return this.report.fullReportSize}reportSizeInBytes(){return Math.ceil(this.reportSizeInBits()/8)}createBitViewIfNeeded(){if(!this.bitView){const e=this.reportSizeInBytes(),t=new ArrayBuffer(e);this.bitView=new l.BitView(t),this.bitView.bigEndian=!1}return this.bitView}getUsageInformationOrThrow(e){if(!this.report.usages.has(e))throw new R(`Unable to write usage (0x${e.toString(16).padStart(8,"0")}). It is not known by the device.`,w.UNEXPECTED_ERROR);return this.report.usages.get(e)}writeUsage(e,t){const s=this.getUsageInformationOrThrow(e);let i=this.createBitViewIfNeeded();if(!s.absolute){const e=function(e){const t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t}(i.buffer);i=new l.BitView(e)}return i.setBits(s.offset,t,s.size),i.buffer}}class N{constructor(e,t,s){this.device=e,this.outputReports=t,this.outputUsages=s,this.outputCacheByReportId=new Map}getReportIdForUsage(e){if(!this.outputUsages.has(e))throw new R(`Unknown usagePage: 0x${e.toString(16).padStart(8,"0")}.`,w.UNEXPECTED_ERROR);return this.outputUsages.get(e)}getReportLayoutForReportId(e){if(!this.outputReports.has(e))throw new R(`Unknown reportId: ${e}.`,w.UNEXPECTED_ERROR);return this.outputReports.get(e)}getUsageInReportForUsage(e){const t=this.getReportIdForUsage(e),s=this.getReportLayoutForReportId(t);if(!s.usages.has(e))throw new R(`Unknown rawUsage inside ReportLayout: ${e}.`,w.UNEXPECTED_ERROR);return s.usages.get(e)}getOrCreateCacheForReportId(e){if(!this.outputCacheByReportId.has(e)){const t=this.getReportLayoutForReportId(e),s=new M(t);this.outputCacheByReportId.set(e,s)}return this.outputCacheByReportId.get(e)}sendOutputUsage(e,t){return u(this,void 0,void 0,(function*(){const s=this.getReportIdForUsage(e),i=this.getOrCreateCacheForReportId(s),o=this.getUsageInReportForUsage(e);let r=t?1:0;r=o.onOutput(r);const n=i.writeUsage(e,r);yield this.device.sendReport(s,n)}))}}class O{constructor(e=new Map,t=0){this.usages=e,this.fullReportSize=t}}class P{constructor(e,t,s){this.offset=e,this.size=t,this.absolute=s}onInput(e){return e}onOutput(e){return e}}class x{constructor(e,t,s,i){this.offset=e,this.size=t,this.absolute=s,this.rangeIndex=i}onInput(e){return e===this.rangeIndex?1:0}onOutput(e){return e>0?this.rangeIndex:e}}class A{constructor(e){const t=new Map;this.buildReportLayouts(e.collections,"input",t),this.inputReports=t,this.inputUsages=A.buildUsageMap(t);const s=new Map;this.buildReportLayouts(e.collections,"output",s),this.outputReports=s,this.outputUsages=A.buildUsageMap(s);const i=new Map;this.buildReportLayouts(e.collections,"feature",i),this.featureReports=i,this.featureUsages=A.buildUsageMap(i)}static buildUsageMap(e){const t=new Map;return e.forEach((e,s)=>{e.usages.forEach((e,i)=>{t.set(i,s)})}),t}buildReportLayouts(e,t,s){e.forEach(e=>{var i;null===(i=A.reportsOfType(e,t))||void 0===i||i.forEach(e=>{var t;const i=e.reportId;s.has(i)||s.set(i,new O);const o=s.get(i);let r=0;null===(t=e.items)||void 0===t||t.forEach(e=>{let t=e.usages;if(e.isRange){t=[];for(let s=e.usageMinimum;s<=e.usageMaximum;s+=1)t.push(s)}let s,i=r;e.isRange&&e.isArray&&(s=1),t.forEach(t=>{let r;r=s?new x(i,e.reportSize,e.isAbsolute,s):new P(i,e.reportSize,e.isAbsolute),o.usages.set(t,r),s?s+=1:i+=e.reportSize});const n=e.reportCount*e.reportSize;o.fullReportSize+=n,r+=n})}),e.children&&this.buildReportLayouts(e.children,t,s)})}static reportsOfType(e,t){if("input"===t)return e.inputReports;if("output"===t)return e.outputReports;if("feature"===t)return e.featureReports;throw new R(`Unexpected report type: ${t}!`,w.UNEXPECTED_ERROR)}}class T{constructor(e,t,s){this.device=e,this.featureReports=t,this.featureUsages=s,this.outputCacheByReportId=new Map}getReportIdForUsage(e){if(!this.featureUsages.has(e))throw new R(`Unknown usagePage: 0x${e.toString(16).padStart(8,"0")}.`,w.UNEXPECTED_ERROR);return this.featureUsages.get(e)}getReportLayoutForReportId(e){if(!this.featureReports.has(e))throw new R(`Unknown reportId: ${e}.`,w.UNEXPECTED_ERROR);return this.featureReports.get(e)}getUsageInReportForUsage(e){const t=this.getReportIdForUsage(e),s=this.getReportLayoutForReportId(t);if(!s.usages.has(e))throw new R(`Unknown rawUsage inside ReportLayout: ${e}.`,w.UNEXPECTED_ERROR);return s.usages.get(e)}getOrCreateCacheForReportId(e){if(!this.outputCacheByReportId.has(e)){const t=this.getReportLayoutForReportId(e),s=new M(t);this.outputCacheByReportId.set(e,s)}return this.outputCacheByReportId.get(e)}getFeatureUsage(e){return u(this,void 0,void 0,(function*(){const t=this.getReportIdForUsage(e);return(yield this.device.receiveFeatureReport(t)).getUint8(1)>0}))}setFeatureUsage(e,t){return u(this,void 0,void 0,(function*(){const s=this.getReportIdForUsage(e),i=this.getOrCreateCacheForReportId(s),o=this.getUsageInReportForUsage(e);let r=t?1:0;r=o.onOutput(r);const n=i.writeUsage(e,r);yield this.device.sendFeatureReport(s,n)}))}}class H{constructor(e,t,s,i){this.name=e,this.vid=t,this.pid=s,i.sessionId?this.id=i.sessionId:(this.id=new f(4).toString(),i.sessionId=this.id);const o=new A(i);this.inputReports=o.inputReports,this.outputReports=o.outputReports,this.featureReports=o.featureReports,this.inputHandler=new S(i,o.inputReports),this.outputHandler=new N(i,o.outputReports,o.outputUsages),this.featureHandler=new T(i,o.featureReports,o.featureUsages)}}class B{constructor(e,t){this.hid=e,this.broadcastChannel=t,this.deviceAddedSubject=new r,this.deviceAdded=this.deviceAddedSubject,this.deviceRemovedSubject=new r,this.deviceRemoved=this.deviceRemovedSubject}setupListeners(){this.hid.onconnect=e=>this.onConnect(e),this.hid.ondisconnect=e=>this.onDisconnect(e),this.broadcastChannel.onmessage=()=>this.getPairedDevices()}addNewDevice(e){return u(this,void 0,void 0,(function*(){const t=new H(e.productName,e.vendorId,e.productId,e);e.opened||(yield e.open()),this.deviceAddedSubject.next(t)}))}onConnect(e){return u(this,void 0,void 0,(function*(){yield this.addNewDevice(e.device)}))}onDisconnect(e){this.deviceRemovedSubject.next(new H(e.device.productName,e.device.vendorId,e.device.productId,e.device))}getPairedDevices(){return u(this,void 0,void 0,(function*(){(yield this.hid.getDevices()).forEach(e=>u(this,void 0,void 0,(function*(){yield this.addNewDevice(e)})))}))}}class z{constructor(e,t,s,i,o){this.usagePage=e,this.usage=t,this.valueType=s,this.reportType=i,this.reportSize=o}}class _{constructor(e){this.deviceManagement=e,this.events=new r,this.setupDeviceHandler()}setupDeviceHandler(){this.deviceManagement.deviceAdded.subscribe(e=>{this.events.next({event:"attach",id:e.id,vid:e.vid,pid:e.pid,name:e.name,descriptor:_.generateDescriptors(e)})}),this.deviceManagement.deviceRemoved.subscribe(e=>{this.events.next({event:"detach",id:e.id})}),this.deviceManagement.onHidInput.subscribe(e=>{this.events.next({event:"hid-input",id:e.deviceId,usagePage:e.usagePage,usage:e.usage,value:e.value})}),this.deviceManagement.onGetFeatureReportResponse.subscribe(e=>{this.events.next({event:"response-hid-feature",token:e.token,value:e.value?1:0})})}static generateDescriptors(e){let t=_.convertReportLayoutsToDescriptors(e.inputReports,"input");return t=t.concat(_.convertReportLayoutsToDescriptors(e.outputReports,"output")),t=t.concat(_.convertReportLayoutsToDescriptors(e.featureReports,"feature")),t}static convertReportLayoutsToDescriptors(e,t){const s=[];return e.forEach(e=>{e.usages.forEach((e,i)=>{const o=D.usagePageFromRaw(i);65280===o&&"output"===t||s.push(new z(o,D.usageFromRaw(i),e.absolute?"absolute":"relative",t,Math.ceil(e.size/8)))})}),s}}class q{constructor(e,t,s){this.deviceManagement=e,this.callLockManagement=t,this.logger=s,this.gnpLockAcquired=new r,this.callLockAcquired=new r,this.softphoneInFocus=new r,this.events=b(this.gnpLockAcquired.pipe(E(0)),this.callLockAcquired.pipe(E(0)),this.softphoneInFocus)}onNewSdkInput(e){if(!e.action)throw new R("Provided input has no action property.",w.UNEXPECTED_ERROR);switch(e.action){case"hid-output":this.deviceManagement.sendOutputUsage(e.id,e.usagePage,e.usage,e.value);break;case"request-hid-feature":this.deviceManagement.getFeatureUsage(e.id,e.token,e.usagePage,e.usage);break;case"set-hid-feature":this.deviceManagement.setFeatureUsage(e.id,e.usagePage,e.usage,e.value);break;case"request-gnp-lock":this.gnpLockAcquired.next({event:"response-gnp-lock",token:e.token}),I("GNP lock requested with WeBHID backend. This should not happen!",this.logger,k.ERROR,U.NATIVE_CONSOLE);break;case"release-gnp-lock":break;case"request-call-lock":this.callLockManagement.tryAcquireCallLock(e.id).then(t=>{this.callLockAcquired.next({event:"response-call-lock",id:e.id,acquired:t})});break;case"release-call-lock":this.callLockManagement.releaseCallLock(e.id);break;case"set-softphone-info":this.softphoneInFocus.next({event:"softphone-in-focus",infocus:!1}),this.softphoneInFocus.complete();break;default:throw new R(`Provided action is not recognized - ${e.action}.`,w.UNEXPECTED_ERROR)}}}class V{constructor(e,t){this.navigatorLocks=e,this.releaseGlobalLock=null,this.localLockedDevices=new Set,t.deviceRemoved.subscribe(e=>{this.localLockedDevices.has(e.id)&&this.releaseCallLock(e.id)})}tryAcquireCallLock(e){return this.localLockedDevices.size>0&&!this.localLockedDevices.has(e)?(this.localLockedDevices.add(e),Promise.resolve(!0)):new Promise(t=>{this.navigatorLocks.request("jabra-call-lock",{ifAvailable:!0},s=>s?(this.localLockedDevices.add(e),t(!0),new Promise(e=>{this.releaseGlobalLock=e})):(t(!1),Promise.resolve()))})}releaseCallLock(e){this.localLockedDevices.delete(e),this.releaseGlobalLock&&0===this.localLockedDevices.size&&this.releaseGlobalLock()}}class j{constructor(e,t,s,i){this.scanner=e,this.deviceEventHandler=t,this.sdkInputEventHandler=s,this.logger=i,this.readyEvent=new r,this.events=new v,this.events=b(this.readyEvent,this.deviceEventHandler.events,this.sdkInputEventHandler.events)}start(){this.readyEvent.next({event:"ready",version:null,jabraDirectInstalled:!1}),this.readyEvent.complete(),this.scanner.getPairedDevices(),this.scanner.setupListeners()}sendMessage(e){var t;null===(t=this.sdkInputEventHandler)||void 0===t||t.onNewSdkInput(e)}}function X(e){if("undefined"==typeof window||void 0===window.navigator){if(void 0===window.navigator.hid)throw new R("WebHID is not supported on this platform/browser.",w.INIT_ERROR);if(void 0===window.navigator.locks)throw new R("WebLocks is not supported on this platform/browser.",w.INIT_ERROR)}const t=window.navigator.hid,s=window.navigator.locks,i=new BroadcastChannel(y.PAIRING_CHANNEL),o=new B(t,i),r=new C(o),n=new _(r),a=new q(r,new V(s,r));return new j(o,n,a,e)}export{X as initHandler};
